<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Quest: Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiJYvntdGxCWL0z2h6KeYgKrS9w31PW_k&libraries=places"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- PIXEL ART THEME --- */
        body { font-family: 'Press Start 2P', cursive; background-color: #ffffff; overflow-x: hidden; color: #333; margin: 0; padding: 0; }
        #world { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('static/bg.png') repeat-x bottom; background-size: cover; z-index: -1; }
        
        /* UI COMPONENTS */
        .pixel-card { background: white; border: 4px solid #000; box-shadow: 6px 6px 0px rgba(0,0,0,0.5); position: relative; }
        .pixel-btn { background: #ffcc00; border: 4px solid #000; padding: 15px; cursor: pointer; box-shadow: 4px 4px 0px #000; transition: 0.1s; display: inline-block; font-size: 10px; }
        .pixel-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        .pixel-btn:hover { background: #ffe566; }
        .pixel-input { border: 4px solid #000; padding: 10px; font-family: 'Press Start 2P'; font-size: 10px; width: 100%; background: #f3f4f6; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; align-items: center; justify-content: center; }
        .modal.visible { display: flex; }
        
        /* Ensure modal content allows cat to stick out */
        .modal-content { max-width: 1100px; width: 95%; position: relative; max-height: 90vh; overflow: visible; }
        .modal-result-content { max-width: 1200px; width: 95%; position: relative; max-height: 90vh; overflow-y: auto;}

        /* MAP STYLES */
        .map-container { display: flex; flex-direction: column; align-items: center; position: relative; padding: 40px 0; min-height: 500px; }
        .map-line { position: absolute; top: 0; bottom: 0; left: 50%; width: 8px; background: #d1d5db; transform: translateX(-50%); z-index: 0; }
        .map-node { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #000; background: #e5e7eb; display: flex; align-items: center; justify-content: center; margin: 25px 0; z-index: 10; position: relative; transition: 0.2s; }
        .map-node.unlocked { background: #ffcc00; cursor: pointer; box-shadow: 0 6px 0 #b38f00; transform: scale(1.1); }
        .map-node.completed { background: #4ade80; border-color: #166534; color: #166534; }
        
        /* HOVER TOOLTIPS */
        .node-label { position: absolute; left: 100px; width: 180px; background: white; padding: 8px; border: 4px solid black; font-size: 8px; display: none; z-index: 20; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); text-align: left; }
        .map-node:hover .node-label { display: block; }

        /* ANIMATIONS */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .image-pixelated { image-rendering: pixelated; }

        /* --- ANGEL & DEVIL CAT STYLES --- */
        .cat-avatar { width: 150px; height: 150px; image-rendering: pixelated; object-fit: contain; }
        .angel-cat-wrapper { position: relative; }
        .angel-cat { filter: brightness(1.2) drop-shadow(0 0 10px #facc15); }
        .angel-halo { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 40px; text-shadow: 0 0 5px yellow; animation: float 2s infinite; }
        .devil-cat-wrapper { position: relative; }
        .devil-cat { filter: saturate(1.2) contrast(1.2) drop-shadow(0 0 5px red); }
        .devil-horns { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); font-size: 30px; text-shadow: 0 0 5px red; }

        /* Pixel Cloud Speech Bubble */
        .pixel-bubble { background: #fff; border: 4px solid #000; padding: 15px; position: relative; font-size: 10px; line-height: 1.5; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); max-width: 300px; opacity: 0; transition: opacity 0.5s ease-in; display: none; }
        .pixel-bubble.visible { opacity: 1; display: block; }
        .bubble-left::after { content: ''; position: absolute; left: -10px; top: 50%; border-right: 10px solid #000; border-top: 10px solid transparent; border-bottom: 10px solid transparent; }
        .bubble-right::after { content: ''; position: absolute; right: -10px; top: 50%; border-left: 10px solid #000; border-top: 10px solid transparent; border-bottom: 10px solid transparent; }

        /* --- NEW CAT SYSTEM STYLES --- */
        
        /* 1. Cat Hug Effect (Start Screen) */
        .cat-hug-top { 
            position: absolute; 
            width: 700px; 
            top: -370px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 20; 
            image-rendering: pixelated; 
            pointer-events: none; 
        }
        .cat-hug-bottom { 
            position: absolute; 
            bottom: -380px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 600px; 
            z-index: -1; 
            image-rendering: pixelated; 
            pointer-events: none;
        }

        /* 2. Floating Guide Cat - RIGID CONTAINER */
        #guide-cat-container { 
            position: fixed; 
            z-index: 100; 
            transition: all 1s ease-in-out; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            width: 150px; 
            pointer-events: none; 
        }
        
        /* PREVENTS JUMPING: Fixed Height for Image */
        #guide-cat-img { 
            width: 100%; 
            height: 250px; 
            object-fit: contain; 
            image-rendering: pixelated; 
            drop-shadow: 4px 4px 0 rgba(0,0,0,0.3); 
        }

        /* PREVENTS JUMPING: Fixed Min-Height for Bubble */
        .guide-bubble { 
            background: white; 
            border: 4px solid black; 
            padding: 20px;          
            font-size: 14px;        
            width: 250px;           
            min-height: 80px;
            margin-bottom: 10px; 
            text-align: center; 
            border-radius: 12px; 
            opacity: 0; 
            transition: opacity 0.5s; 
            position: relative; 
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center; 
        }

        /* 3. Walking Map Cat */
        .map-cat-avatar { 
            width: 100px; 
            height: 100px; 
            object-fit: contain; /* FIXES STRETCHING */
            position: absolute; 
            bottom: 20px; /* Adjusts vertical position to stand ON the node */
            right: 6px;    /* Centers horizontally relative to the node */
            z-index: 20; 
            image-rendering: pixelated; 
            animation: bounce 1s infinite; 
            pointer-events: none; 
        }

        /* Updated Animation: Includes Horizontal Centering + Vertical Bounce */
        @keyframes bounce { 
            0%, 100% { transform: translateX(-50%) translateY(0); } 
            50% { transform: translateX(-50%) translateY(-10px); } 
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="world"></div>

    <div id="guide-cat-container">
        <div id="guide-msg" class="guide-bubble">Hello!</div>
        <img id="guide-cat-img" src="static/catcloud.png">
    </div>

    <nav class="fixed top-0 w-full bg-black/90 text-white p-3 z-[60] border-b-4 border-gray-600 flex justify-between items-center">
        <span class="text-yellow-400 text-xs tracking-widest">CAREER<span class="text-white">QUEST</span></span>
        <div class="flex gap-4 items-center">
            <button onclick="showProgress()" class="text-[8px] hover:text-yellow-400 bg-gray-800 px-2 py-1 border border-gray-600 rounded">üìä REPORT</button>
            <div class="text-[8px] text-green-400 bg-green-900 px-2 py-1 border border-green-500 rounded">‚óè ONLINE</div>
        </div>
    </nav>

    <div id="screen-start" class="modal visible">
        <div class="modal-content pixel-card p-10 text-center max-w-2xl mt-10">
            <img src="static/catpeep.png" class="cat-hug-top">

            <h1 class="text-xl md:text-3xl mb-8 text-blue-800 leading-relaxed mt-4">CHOOSE YOUR<br>DESTINY</h1>
            
            <div class="grid md:grid-cols-2 gap-8 relative z-30">
                <button onclick="openRoleSelect()" class="pixel-btn bg-blue-300 hover:bg-blue-400">
                    <div class="text-4xl mb-4">üó∫Ô∏è</div>
                    <div class="text-sm font-bold mb-2">DIRECT ROADMAP</div>
                </button>
                <button onclick="startAnalysis()" class="pixel-btn bg-purple-300 hover:bg-purple-400">
                    <div class="text-4xl mb-4">üß¨</div>
                    <div class="text-sm font-bold mb-2">DISCOVER PATH</div>
                </button>
            </div>

            <img src="static/cattail.png" class="cat-hug-bottom">
        </div>
    </div>

    <div id="screen-role" class="modal">
        <div class="modal-content pixel-card p-8 text-center max-w-lg">
            <h2 class="text-sm mb-6 bg-blue-200 inline-block px-2 border-2 border-black">SELECT TARGET JOB</h2>
            <select id="role-select" class="w-full border-4 border-black p-4 mb-6 font-sans font-bold bg-gray-100 text-sm">
                <option>Frontend Developer</option><option>Backend Engineer</option><option>Data Scientist</option>
                <option>Cybersecurity Analyst</option><option>Game Developer</option><option>AI Engineer</option>
            </select>
            <button onclick="fetchRoadmap()" class="pixel-btn w-full font-bold">GENERATE ROADMAP</button>
        </div>
    </div>

    <div id="screen-roadmap" class="modal">
        <div class="modal-content pixel-card p-4 h-[90vh] flex flex-col relative bg-slate-100 border-none">
            <button onclick="location.reload()" class="absolute top-4 right-4 bg-red-500 text-white border-2 border-black px-2 py-1 text-[8px] hover:bg-red-600 z-50">EXIT</button>
            
            <h2 class="text-center text-sm mb-4 border-b-4 border-black pb-4 pt-2">PATH TO: <span id="job-title" class="text-blue-600 bg-blue-100 px-2">...</span></h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow overflow-hidden h-full">
                <div class="lg:col-span-1 flex flex-col gap-4 overflow-y-auto pr-2 pb-10">
                    <div id="box-deadline" class="bg-yellow-100 border-4 border-black p-4">
                        <h3 class="text-[10px] text-center mb-2 font-bold"><i class="fa-regular fa-clock"></i> DEADLINE TRACKER</h3>
                        <input type="number" id="study-hours" class="pixel-input mb-2" placeholder="e.g. 2" oninput="calculateDeadline()">
                        <div id="deadline-result" class="text-[8px] font-bold text-blue-600 text-center mt-2 border-t-2 border-black pt-2">Enter hours...</div>
                    </div>
                    <div id="box-boss" class="bg-red-100 border-4 border-black p-4 text-center">
                        <h3 class="text-[10px] font-bold mb-2">BOSS BATTLE</h3>
                        <button onclick="startInterview()" class="pixel-btn bg-red-400 hover:bg-red-500 text-white w-full">ENTER ARENA</button>
                    </div>
                    <div id="box-radar" class="bg-white border-4 border-black p-4">
                        <h3 class="text-[10px] text-center mb-4 bg-gray-200 border-2 border-black p-1">SKILLS</h3>
                        <canvas id="roadmapChart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-blue-50 border-4 border-black overflow-y-auto relative p-8 shadow-inner" id="map-scroll-area">
                    <div class="map-container" id="map-area"><div class="map-line"></div></div>
                    <div class="h-20"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-offer" class="modal">
        <div class="modal-content pixel-card p-6 text-center max-w-4xl border-blue-500 bg-blue-50 relative h-[90vh] flex flex-col">
            <div class="absolute -top-12 left-1/2 transform -translate-x-1/2 animate-bounce">
                 <img src="static/catcloudhappy.png" class="w-24 image-pixelated">
            </div>
            <h2 class="text-xs mb-2 bg-blue-200 inline-block px-2 border-2 border-black p-2 mt-6">QUEST LOCATIONS</h2>
            
            <div id="job-map" class="w-full h-64 border-4 border-black mb-4 bg-gray-200"></div>

            <p class="text-[10px] mb-2 text-blue-800">Available Quests Detected:</p>
            <div id="offer-list" class="flex flex-col gap-3 flex-grow overflow-y-auto p-2 border-4 border-black bg-slate-100 mb-4">
                <div class="text-xs text-gray-500">Scanning Indian Tech Hubs...</div>
            </div>
            <div class="mt-4">
                <button onclick="closeOffer()" class="pixel-btn bg-gray-200 hover:bg-gray-300 w-full">IGNORE</button>
            </div>
        </div>
    </div>

    <div id="screen-details" class="modal z-[100]">
        <div class="modal-content pixel-card p-6 w-full max-w-4xl bg-slate-50 border-blue-800 border-4 h-[90vh] overflow-y-auto" style="margin-left: 20%;">
            <button onclick="document.getElementById('screen-details').classList.remove('visible')" class="absolute top-4 right-4 text-red-500 font-bold border-2 border-red-500 px-2 hover:bg-red-100">X</button>
            <h2 class="text-center text-xl mb-2 text-blue-800 font-bold border-b-4 border-black pb-4">MARKET ANALYSIS: <span id="detail-title" class="text-black">...</span></h2>
            
            <div class="grid md:grid-cols-2 gap-8 mt-6">
                <div class="bg-white border-4 border-black p-4 shadow-[4px_4px_0px_rgba(0,0,0,0.2)]">
                    <h3 class="text-xs text-center mb-2 bg-yellow-200 inline-block px-2 border border-black">POPULARITY TREND (1 YR)</h3>
                    <div class="h-64"><canvas id="trendChart"></canvas></div>
                    <p class="text-[8px] text-gray-500 text-center mt-2">Data Source: AI Market Predictions</p>
                </div>
                <div class="bg-white border-4 border-black p-4 shadow-[4px_4px_0px_rgba(0,0,0,0.2)]">
                    <h3 class="text-xs text-center mb-2 bg-blue-200 inline-block px-2 border border-black">ELIGIBILITY MATCH</h3>
                    <div class="h-64"><canvas id="skillMatchChart"></canvas></div>
                    <p class="text-[8px] text-gray-500 text-center mt-2">Blue: You | Red: Required</p>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="btn-start-path" class="pixel-btn bg-green-400 hover:bg-green-500 text-sm py-4 px-8 animate-pulse">
                    ACCEPT DESTINY & START ROADMAP
                </button>
            </div>
        </div>
    </div>

    <div id="screen-interview" class="modal">
        <div class="modal-content pixel-card p-0 max-w-2xl h-[80vh] flex flex-col border-red-500 border-4">
            <div class="bg-red-600 text-white p-4 font-bold text-center border-b-4 border-black flex justify-between items-center">
                <span><i class="fa-solid fa-skull"></i> INTERVIEW ARENA</span>
                <button onclick="closeInterview()" class="text-[10px] bg-red-800 px-2 py-1 border border-black">ESCAPE</button>
            </div>
            <div id="interview-log" class="flex-grow bg-slate-900 p-6 overflow-y-auto flex flex-col gap-4"></div>
            <div class="p-4 bg-gray-200 border-t-4 border-black flex gap-2">
                <input type="text" id="interview-input" class="w-full border-4 border-black p-3 font-sans text-sm" placeholder="Type answer..." onkeypress="if(event.key==='Enter') sendInterviewResponse()">
                <button onclick="sendInterviewResponse()" class="pixel-btn bg-red-500 text-white">SEND</button>
            </div>
        </div>
    </div>

    <div id="screen-quiz" class="modal text-center">
        <div class="modal-content pixel-card p-8 max-w-lg">
            <h2 class="text-xs mb-6 bg-blue-200 inline-block px-2 border-2 border-black p-2">PHASE 1: BEHAVIOR SCAN</h2>
            <h3 id="q-text" class="mb-8 h-16 flex items-center justify-center text-sm">Loading...</h3>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-a" onclick="answerQuiz(0)" class="pixel-btn bg-white">OPTION A</button>
                <button id="btn-b" onclick="answerQuiz(1)" class="pixel-btn bg-white">OPTION B</button>
            </div>
            <p class="text-[8px] mt-4 text-gray-400">QUESTION <span id="q-idx">1</span>/5</p>
        </div>
    </div>

    <div id="screen-resume" class="modal text-center">
        <div class="modal-content pixel-card p-8 max-w-lg">
            <h2 class="text-xs mb-6 bg-green-200 inline-block px-2 border-2 border-black p-2">PHASE 2: RESUME SCAN</h2>
            
            <div class="border-4 border-black border-dashed p-6 mb-6 bg-gray-50 hover:bg-gray-100 transition-colors flex flex-col items-center justify-center">
                <i class="fa-solid fa-file-pdf text-3xl mb-2 text-red-500"></i>
                <p class="text-[8px] mb-4">UPLOAD RESUME (PDF/TXT)</p>
                
                <input type="file" id="resume-upload" accept=".pdf, .txt" class="ml-12 text-[8px] file:mr-4 file:py-2 file:px-4 file:border-2 file:border-black file:text-[8px] file:font-bold file:bg-yellow-300 hover:file:bg-yellow-400 cursor-pointer">
            </div>

            <button onclick="submitResume()" class="pixel-btn w-full">SCAN DATA</button>
            <p id="resume-status" class="text-[8px] text-red-500 mt-2 hidden animate-pulse">ANALYZING...</p>
        </div>
    </div>

    <div id="screen-interests" class="modal text-center">
        <div class="modal-content pixel-card p-8 max-w-lg">
            <h2 class="text-xs mb-6 bg-purple-200 inline-block px-2 border-2 border-black p-2">PHASE 3: INTERESTS</h2>
            <div class="grid grid-cols-2 gap-3 mb-6" id="interest-grid"></div>
            <button onclick="finishAnalysis()" class="pixel-btn w-full">CALCULATE ARCHETYPE</button>
            <p id="analysis-status" class="text-[8px] text-red-500 mt-2 hidden animate-pulse">GENERATING...</p>
        </div>
    </div>

    <div id="screen-progress" class="modal">
        <div class="modal-content pixel-card p-8 max-w-lg text-center relative">
            <button onclick="document.getElementById('screen-progress').classList.remove('visible')" class="absolute top-4 right-4 bg-red-500 text-white border-2 border-black px-2 hover:bg-red-600">X</button>
            
            <h2 class="text-xs mb-6 bg-yellow-200 inline-block px-2 border-2 border-black p-2">PLAYER STATS</h2>
            
            <div class="grid grid-cols-2 gap-4 text-left mb-6">
                <div class="border-2 border-black p-2 bg-gray-50">
                    <p class="text-[8px] text-gray-500">CURRENT LEVEL</p>
                    <p class="text-xl font-bold text-blue-600" id="report-level">1</p>
                </div>
                <div class="border-2 border-black p-2 bg-gray-50">
                    <p class="text-[8px] text-gray-500">TOTAL XP</p>
                    <p class="text-xl font-bold text-green-600" id="report-xp">0</p>
                </div>
            </div>

            <div class="bg-black text-green-400 font-mono text-[10px] p-4 text-left h-32 overflow-y-auto border-4 border-gray-600">
                > SESSION STARTED...<br>
                > SYSTEM READY.<br>
                <span id="report-log"></span>
            </div>
        </div>
    </div>

    <div id="screen-result" class="modal text-center">
        <div class="modal-result-content pixel-card p-8 bg-slate-50 border-4 border-black w-full" style="margin-left: 20%;">
            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                
                <div class="w-full md:w-1/4 flex flex-col items-center">
                    <div class="angel-cat-wrapper animate-float">
                        <div class="angel-halo"></div>
                        <img src="static/angel.png" class="cat-avatar angel-cat">
                    </div>
                    <div id="angel-bubble" class="pixel-bubble bubble-left mt-4 text-blue-800 bg-blue-50 border-blue-900">
                        Analyzing your good deeds...
                    </div>
                </div>

                <div class="w-full md:w-2/4 flex flex-col items-center z-10">
                    <h2 class="text-xs text-yellow-600 mb-2">ANALYSIS COMPLETE</h2>
                    <h1 class="text-xl md:text-2xl text-black mb-6 border-b-4 border-black pb-4">
                        CLASS: <span id="archetype-name" class="text-blue-600">...</span>
                    </h1>
                    <div id="rec-jobs" class="flex flex-col gap-3 mb-6 w-full"></div>
                    <div class="mt-4">
                        <button onclick="location.reload()" class="text-[10px] text-red-500 underline">RESTART</button>
                    </div>
                </div>

                <div class="w-full md:w-1/4 flex flex-col items-center">
                    <div class="devil-cat-wrapper animate-float" style="animation-delay: 1s;">
                        <div class="devil-horns"></div>
                        <img src="static/devil.png" class="cat-avatar devil-cat">
                    </div>
                    <div id="devil-bubble" class="pixel-bubble bubble-right mt-4 text-red-800 bg-red-50 border-red-900">
                        Waiting to crush dreams...
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="chat-widget" class="fixed bottom-6 right-6 z-50 flex flex-col items-end font-sans">
        <div id="chat-window" class="hidden flex-col mb-4 w-72 h-80 bg-white border-4 border-black shadow-[8px_8px_0px_rgba(0,0,0,0.5)]">
            <div class="bg-blue-600 text-white p-2 text-[10px] font-bold border-b-4 border-black flex justify-between items-center font-['Press_Start_2P']">
                <span>GUIDE.EXE</span>
                <button onclick="toggleChat()" class="hover:text-red-300">X</button>
            </div>
            <div id="chat-log" class="flex-grow overflow-y-auto p-3 bg-slate-100 text-xs flex flex-col gap-2"></div>
            <div class="p-2 border-t-4 border-black bg-gray-200 flex gap-2">
                <input type="text" id="chat-input" class="w-full border-2 border-gray-400 p-1 text-[10px]" placeholder="Ask..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" class="bg-green-500 border-2 border-black px-2 text-white">></button>
            </div>
        </div>
        <button id="btn-chat" onclick="toggleChat()" class="w-16 h-16 bg-yellow-400 border-4 border-black rounded-full shadow-[4px_4px_0px_#000] hover:bg-yellow-300 flex items-center justify-center relative">
            <i class="fa-solid fa-robot text-2xl text-black"></i>
        </button>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let currentStats = [1,1,1,1,1,1]; 
        let targetStats = [5,5,5,5,5,5];
        let currentLevelIndex = 0; 
        let roadmapLevels = [];
        let totalXP = 0;
        const API_BASE = window.location.origin;
        const statLabels = ['Architecture', 'Frontend', 'Data', 'Security', 'Embedded', 'Product'];

        // --- MAP VARIABLES ---
        let map;
        let markers = [];
        let geocoder;

        // --- CAT MANAGER ---
        const guideCat = document.getElementById('guide-cat-container');
        const guideImg = document.getElementById('guide-cat-img');
        const guideMsg = document.getElementById('guide-msg');

        // 1. UPDATED: Only handles Image and Text (No movement)
        function setCatState(state, message = "") {
            guideCat.style.display = 'flex';
            if(message) {
                guideMsg.innerText = message;
                guideMsg.style.opacity = 1;
            } else {
                guideMsg.style.opacity = 0;
            }

            if (state === 'hidden') guideCat.style.display = 'none';
            else if (state === 'cloud') guideImg.src = 'static/catcloud.png';
            else if (state === 'think') guideImg.src = 'static/catcloudthink.png';
            else if (state === 'happy') guideImg.src = 'static/catcloudhappy.png';
            else if (state === 'move') guideImg.src = 'static/catmove.png';
        }

        // 2. UPDATED: Handles Position and Size EXCLUSIVELY
        function resizeCat(size) {
            const bubble = document.getElementById('guide-msg');
            
            if (size === 'big') {
                // Big & Middle Left (Start/Analysis Mode)
                guideCat.style.width = '250px';
                guideCat.style.top = '30%';
                guideCat.style.left = '5%';
                guideCat.style.bottom = 'auto';
                guideCat.style.right = 'auto';
                
                // Big Bubble
                bubble.style.width = '250px';
                bubble.style.fontSize = '14px';
                bubble.style.padding = '20px';
            } 
            else {
                // Small & Bottom Right (Map/Roadmap Mode)
                guideCat.style.width = '150px';
                guideCat.style.bottom = '40px';
                guideCat.style.right = '40px';
                guideCat.style.top = 'auto';
                guideCat.style.left = 'auto';
                
                // Small Bubble
                bubble.style.marginBottom = '-35px'; // Pulls bubble down closer to head
                bubble.style.width = '180px';
                bubble.style.fontSize = '10px';
                bubble.style.padding = '8px';
            }
        }

        function moveCatTo(elementId, message) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const rect = el.getBoundingClientRect();
            
            guideCat.style.bottom = 'auto'; guideCat.style.right = 'auto';
            
            // --- CUSTOM POSITIONING LOGIC ---
            if (elementId === 'btn-chat') {
                // SPECIAL CASE: For the "Ask AI" button (Bottom Right)
                // We move it higher up so it doesn't get cut off
                guideCat.style.top = (rect.top - 170) + 'px';   
                guideCat.style.left = (rect.left - 260) + 'px'; 
            } 
            else {
                // STANDARD CASE: For everything else (Deadline, Boss, etc.)
                guideCat.style.top = (rect.top - 120) + 'px';   
                guideCat.style.left = (rect.left - 250) + 'px'; 
            }
            // -------------------------------
            
            // Mobile adjustments (keep this for responsiveness)
            if (window.innerWidth < 768) { 
               guideCat.style.left = '20px';
               guideCat.style.top = (rect.bottom + 10) + 'px';
            }
            
            guideMsg.innerText = message;
            guideMsg.style.opacity = 1;
        }

        // --- NAVIGATION ---
        function showScreen(id) {
            document.querySelectorAll('.modal').forEach(el => el.classList.remove('visible'));
            document.getElementById(id).classList.add('visible');
        }
        function openRoleSelect() { 
            showScreen('screen-role'); 
            resizeCat('big');
            setCatState('cloud', "Pick a good one!"); 
        }
        function showProgress() {
            const el = document.getElementById('screen-progress');
            if(el) {
                document.getElementById('report-level').innerText = currentLevelIndex + 1;
                document.getElementById('report-xp').innerText = totalXP;
                el.classList.add('visible');
            } else {
                console.error("Error: screen-progress div is missing!");
            }
        }

        // --- TUTORIAL SEQUENCE ---
        async function runRoadmapTutorial() {
            setCatState('move', "I'm your Guide!");
            // Manually override for tutorial start
            guideCat.style.top = '20%'; guideCat.style.left = '45%';
            guideCat.style.bottom = 'auto'; guideCat.style.right = 'auto';
            await new Promise(r => setTimeout(r, 2000));

            moveCatTo('btn-chat', "Ask AI here!");
            await new Promise(r => setTimeout(r, 2500));

            moveCatTo('box-deadline', "Track hours!");
            await new Promise(r => setTimeout(r, 2500));

            moveCatTo('box-boss', "Beat the Boss!");
            await new Promise(r => setTimeout(r, 2500));
            
            setCatState('hidden');
            renderMap();
        }

        // --- ANALYSIS LOGIC ---
        let qIdx = 0;
        const questions = [
            ["Weekend Project?", "Build App (Front)", 1, "Hack Server (Sec)", 3],
            ["Data Source?", "SQL DB (Arch)", 0, "Excel Sheet (Prod)", 5],
            ["New Device?", "Reverse Engineer (Embed)", 4, "Sketch UI (Front)", 1],
            ["Team Role?", "Lead (Prod)", 5, "Researcher (Data)", 2],
            ["Bug Found?", "Fix Code (Front)", 1, "Check Logs (Arch)", 0]
        ];
        function startAnalysis() {
            currentStats = [0,0,0,0,0,0]; qIdx = 0;
            showScreen('screen-quiz'); 
            resizeCat('big');
            setCatState('cloud', "I'm watching...");
            renderQuestion();
        }
        function renderQuestion() {
            if(qIdx >= questions.length) { showScreen('screen-resume'); return; }
            const q = questions[qIdx];
            document.getElementById('q-text').innerText = q[0];
            document.getElementById('btn-a').innerText = q[1];
            document.getElementById('btn-b').innerText = q[3];
            document.getElementById('q-idx').innerText = qIdx + 1;
        }
        function answerQuiz(choice) {
            const q = questions[qIdx];
            currentStats[choice === 0 ? q[2] : q[4]]++;
            qIdx++; renderQuestion();
        }
        async function submitResume() {
            const fileInput = document.getElementById('resume-upload');
            
            if(fileInput.files.length === 0) { 
                alert("Please upload a file!"); 
                return; 
            }

            document.getElementById('resume-status').classList.remove('hidden');
            setCatState('think', "Reading PDF...");
            
            // Create FormData object to send file
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                // Note: We do NOT set 'Content-Type': 'application/json' here
                // The browser sets the multipart boundary automatically
                const res = await fetch(`${API_BASE}/analyze_resume`, {
                    method: 'POST',
                    body: formData 
                });
                
                const data = await res.json();
                
                // Add extracted stats to current stats
                for(let i=0; i<6; i++) currentStats[i] += (data.resume_stats[i] || 0);
                
                document.getElementById('resume-status').classList.add('hidden');
                setupInterests(); 
                showScreen('screen-interests');
                setCatState('cloud', "Almost done!");
            } catch (e) { 
                console.error(e);
                alert("Resume Agent Offline. Using default stats."); 
                showScreen('screen-interests'); 
            }
        }
        function setupInterests() {
            const interests = ["Cloud Computing", "UI/UX Design", "Big Data", "Ethical Hacking", "Robotics", "Startup Mgmt"];
            const grid = document.getElementById('interest-grid');
            grid.innerHTML = "";
            interests.forEach((int, idx) => {
                grid.innerHTML += `<button onclick="toggleInt(${idx}, this)" class="pixel-btn bg-white text-[8px] border-2 border-black w-full">${int}</button>`;
            });
        }
        function toggleInt(idx, btn) { currentStats[idx] += 1; btn.style.background = "#86efac"; }
        
        async function finishAnalysis() {
            document.getElementById('analysis-status').classList.remove('hidden');
            setCatState('think', "Calculating...");
            try {
                const res = await fetch(`${API_BASE}/generate_report`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ stats: currentStats, interests: "UI Selection" })
                });
                const data = await res.json();
                
                showScreen('screen-result');
                setCatState('happy', "We found it!");

                document.getElementById('archetype-name').innerText = data.archetype.toUpperCase();
                const container = document.getElementById('rec-jobs');
                container.innerHTML = "";
                data.jobs.forEach(job => {
                    container.innerHTML += `
                    <button onclick="openJobDetails('${job}')" class="bg-yellow-300 border-2 border-black p-3 text-xs font-bold hover:bg-yellow-400 text-left flex justify-between items-center shadow-md w-full mb-2">
                        <span>${job.toUpperCase()}</span>
                        <span class="text-[8px] bg-white border border-black px-1">üìä VIEW DATA</span>
                    </button>`;
                });

                const angelBubble = document.getElementById('angel-bubble');
                const devilBubble = document.getElementById('devil-bubble');
                angelBubble.classList.remove('visible'); devilBubble.classList.remove('visible');
                angelBubble.innerText = data.angel_analysis || "Good job!";
                devilBubble.innerText = data.devil_analysis || "You will fail.";
                setTimeout(() => { angelBubble.classList.add('visible'); }, 1000);
                setTimeout(() => { devilBubble.classList.add('visible'); }, 6000);

            } catch (e) { console.error(e); } finally { document.getElementById('analysis-status').classList.add('hidden'); }
        }

        // --- JOB DETAILS & CHARTS LOGIC ---
        let trendChart = null;
        let skillChart = null;

        async function openJobDetails(roleName) {
            document.getElementById('screen-details').classList.add('visible');
            document.getElementById('detail-title').innerText = roleName.toUpperCase();
            
            const startBtn = document.getElementById('btn-start-path');
            startBtn.onclick = () => {
                document.getElementById('screen-details').classList.remove('visible');
                fetchRoadmap(roleName); 
            };
            startBtn.innerText = "LOADING MARKET DATA...";
            startBtn.disabled = true;
            startBtn.classList.add('bg-gray-400');

            try {
                const res = await fetch(`${API_BASE}/get_job_details`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ role: roleName })
                });
                const data = await res.json();

                if(trendChart) trendChart.destroy();
                const ctx1 = document.getElementById('trendChart');
                trendChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                        datasets: [{
                            label: 'Market Demand',
                            data: data.trends,
                            borderColor: '#eab308', 
                            backgroundColor: 'rgba(234, 179, 8, 0.2)',
                            borderWidth: 4,
                            pointBackgroundColor: '#000',
                            pointBorderColor: '#000',
                            tension: 0.4, 
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                    }
                });

                if(skillChart) skillChart.destroy();
                const ctx2 = document.getElementById('skillMatchChart');
                skillChart = new Chart(ctx2, {
                    type: 'radar',
                    data: {
                        labels: statLabels,
                        datasets: [
                            { label: 'Required', data: data.required_stats, borderColor: '#ef4444', borderDash: [5,5], backgroundColor: 'rgba(239, 68, 68, 0.2)' },
                            { label: 'You', data: currentStats, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.5)' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { r: { min: 0, max: 5, ticks: { display: false }, pointLabels: { font: { size: 9, family: "'Press Start 2P'" } } } }
                    }
                });

                startBtn.innerText = "ACCEPT DESTINY & START ROADMAP";
                startBtn.disabled = false;
                startBtn.classList.remove('bg-gray-400');
                startBtn.classList.add('bg-green-400');

            } catch (e) {
                console.error(e);
                startBtn.innerText = "ERROR LOADING DATA (CLICK TO FORCE START)";
                startBtn.disabled = false;
                startBtn.classList.remove('bg-gray-400');
            }
        }

        // --- MAP FUNCTIONS ---
        function initMap() {
            const india = { lat: 20.5937, lng: 78.9629 };
            map = new google.maps.Map(document.getElementById("job-map"), {
                zoom: 4,
                center: india,
                disableDefaultUI: true,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#ebe3cd" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#523735" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#f5f1e6" }] },
                    { featureType: "administrative", elementType: "geometry.stroke", stylers: [{ color: "#c9b2a6" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#f5f1e6" }] },
                    { featureType: "water", elementType: "geometry.fill", stylers: [{ color: "#b9d3c2" }] },
                ],
            });
            geocoder = new google.maps.Geocoder();
        }

        function placeJobMarker(job) {
            if (!geocoder) geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': job.location }, function(results, status) {
                if (status === 'OK') {
                    const marker = new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location,
                        title: job.company,
                        animation: google.maps.Animation.DROP
                    });
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="font-family: 'Press Start 2P'; font-size: 8px;"><strong>${job.company}</strong><br>${job.role}</div>`
                    });
                    marker.addListener("click", () => {
                        infoWindow.open(map, marker);
                    });
                    markers.push(marker);
                }
            });
        }

        // --- ROADMAP & INTERVIEW ---
        async function fetchRoadmap(roleName = null) {
            const role = roleName || document.getElementById('role-select').value;
            
            // 1. Start BIG (Middle Left) for "Building Map..."
            resizeCat('big'); 

            document.getElementById('job-title').innerText = "GENERATING...";
            showScreen('screen-roadmap');
            setCatState('think', "Building map...");
            
            try {
                const res = await fetch(`${API_BASE}/get_roadmap`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ role: role })
                });
                const data = await res.json();
                roadmapLevels = data.levels || [];
                targetStats = data.target_stats;

                let skillCounts = [0,0,0,0,0,0];
                roadmapLevels.forEach(level => { if(level.skill_reward_idx >= 0 && level.skill_reward_idx < 6) skillCounts[level.skill_reward_idx]++; });
                let xpPerSkill = [0,0,0,0,0,0];
                for(let i=0; i<6; i++) {
                    let needed = (targetStats[i] - currentStats[i]) + 1; 
                    if (skillCounts[i] > 0) {
                        if (needed < skillCounts[i]) needed = skillCounts[i]; 
                        xpPerSkill[i] = Math.ceil(needed / skillCounts[i]);
                    }
                }
                roadmapLevels.forEach(level => { if(level.skill_reward_idx >= 0 && level.skill_reward_idx < 6) level.xp = xpPerSkill[level.skill_reward_idx]; });

                document.getElementById('job-title').innerText = role.toUpperCase();
                
                // 2. SNAP TO SMALL (No "Big to Small" Animation)
                // We briefly disable the transition so the size changes instantly
                guideCat.style.transition = 'none'; 
                resizeCat('small'); 
                void guideCat.offsetWidth; // Force a browser refresh of the style
                guideCat.style.transition = 'all 1s ease-in-out'; // Turn animation back on for walking
                // -----------------------------------------------------------

                renderMap(); initGhostChart(); calculateDeadline(); runRoadmapTutorial();

            } catch (e) { alert("Server Error"); }
        }

        function renderMap() {
            const container = document.getElementById('map-area');
            container.innerHTML = '<div class="map-line"></div>';
            roadmapLevels.forEach((level, idx) => {
                const node = document.createElement('div');
                let stateClass = idx < currentLevelIndex ? 'completed' : (idx === currentLevelIndex ? 'unlocked animate-bounce' : 'disabled');
                let icon = idx < currentLevelIndex ? '‚úî' : (idx === currentLevelIndex ? '‚òÖ' : 'üîí');
                
                node.className = `map-node ${stateClass}`;
                node.innerHTML = `<span class="text-2xl">${icon}</span>
                    <div class="node-label">
                        <div class="font-bold text-blue-600">${level.title}</div>
                        <div class="text-[8px] mt-1 text-gray-500">${level.estimated_hours} Hours</div>
                    </div>`;
                if (idx === currentLevelIndex) {
                    node.innerHTML += `<img src="static/agent.png" class="map-cat-avatar">`;
                }
                if (stateClass.includes('unlocked')) node.onclick = () => completeLevel(idx);
                container.appendChild(node);
            });
            if(currentLevelIndex === 0) {
                 const scrollArea = document.getElementById('map-scroll-area');
                 scrollArea.scrollTop = scrollArea.scrollHeight;
            }
        }

        function completeLevel(idx) {
            const level = roadmapLevels[idx];
            alert(`üéâ COMPLETED: ${level.title}\n+${level.xp} XP`);
            currentStats[level.skill_reward_idx] += level.xp;
            totalXP += level.xp;
            currentLevelIndex++;
            renderMap(); updateChart(); calculateDeadline();
            if (idx === 2) triggerJobOffer();
        }

        // --- JOB OFFER (OPPORTUNITIES) ---
        async function triggerJobOffer() {
            setCatState('happy', "I found REAL quests!");
            document.getElementById('screen-offer').classList.add('visible');
            
            // MAP INIT
            setTimeout(() => { initMap(); }, 100);

            const listContainer = document.getElementById('offer-list');
            listContainer.innerHTML = '<div class="text-[10px] animate-pulse">CONNECTING TO JOB SATELLITES...</div>';

            try {
                const role = document.getElementById('job-title').innerText;
                const res = await fetch(`${API_BASE}/get_real_jobs`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ role: role })
                });
                const data = await res.json();
                listContainer.innerHTML = "";

                if(data.jobs && data.jobs.length > 0) {
                    data.jobs.forEach(job => {
                        placeJobMarker(job); // MAP MARKER
                        const jobCard = `
                            <div class="bg-white border-2 border-black p-3 text-left shadow-[2px_2px_0px_rgba(0,0,0,0.2)] hover:bg-yellow-50 transition-colors relative">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-xs text-blue-700 w-48 truncate">${job.role}</h3>
                                        <div class="text-[10px] font-bold text-gray-700">${job.company}</div>
                                    </div>
                                    <div class="text-[8px] bg-red-100 border border-red-500 px-1 text-red-700 rounded animate-pulse">
                                        LIVE
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-2 text-[8px] text-gray-600 mb-2">
                                    <span>üìç ${job.location}</span>
                                    <span>üíº ${job.type}</span>
                                </div>
                                <a href="${job.apply_link}" target="_blank" class="block text-center bg-green-500 text-white text-[8px] py-1 border border-black hover:bg-green-600">
                                    APPLY NOW üîó
                                </a>
                            </div>`;
                        listContainer.innerHTML += jobCard;
                    });
                } else {
                    listContainer.innerHTML = '<div class="text-xs text-red-500">No active quests found in this realm.</div>';
                }
            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div class="text-xs text-red-500">Satellite Connection Failed.</div>';
            }
        }

        function closeOffer() {
            document.getElementById('screen-offer').classList.remove('visible');
            setCatState('move', "Back to work!");
        }

        // --- DEADLINE & CHAT ---
        function calculateDeadline() {
            const hoursPerDay = parseFloat(document.getElementById('study-hours').value);
            const output = document.getElementById('deadline-result');
            if (!hoursPerDay || hoursPerDay <= 0) { output.innerText = "Enter valid hours."; return; }
            let remainingHours = 0;
            for(let i = currentLevelIndex; i < roadmapLevels.length; i++) remainingHours += (roadmapLevels[i].estimated_hours || 5);
            if(remainingHours === 0) { output.innerText = "Completed!"; return; }
            const daysNeeded = Math.ceil(remainingHours / hoursPerDay);
            const finishDate = new Date();
            finishDate.setDate(finishDate.getDate() + daysNeeded);
            output.innerHTML = `Finish by:<br><span class="text-sm text-red-600">${finishDate.toLocaleDateString()}</span><br>(${daysNeeded} days left)`;
        }

        function toggleChat() { document.getElementById('chat-window').classList.toggle('hidden'); document.getElementById('chat-window').classList.toggle('flex'); }
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const log = document.getElementById('chat-log');
            const msg = input.value.trim();
            if(!msg) return;
            log.innerHTML += `<div class="bg-white border-2 border-gray-300 p-2 rounded ml-4 text-right"><strong class="block text-[9px] mb-1 text-gray-500 font-bold">YOU</strong>${msg}</div>`;
            input.value = "";
            try {
                const res = await fetch(`${API_BASE}/chat_agent`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: msg, context: document.getElementById('job-title').innerText })
                });
                const data = await res.json();
                log.innerHTML += `<div class="bg-blue-100 border-2 border-blue-200 p-2 rounded mr-4 text-blue-900"><strong class="block text-[9px] mb-1 text-blue-600 font-bold">GUIDE</strong>${data.reply}</div>`;
                log.scrollTop = log.scrollHeight;
            } catch(e) {}
        }

        // --- INTERVIEW ---
        let interviewHistory = [];
        function startInterview() {
            document.getElementById('screen-interview').classList.add('visible');
            interviewHistory = [];
            document.getElementById('interview-log').innerHTML = `
                <div class="text-green-400 text-xs font-mono p-2 border border-green-800 bg-black">
                    > SYSTEM: Interviewer Bot v1.0 Loaded.<br>
                    > SYSTEM: Topic - ${document.getElementById('job-title').innerText}
                </div>`;
            sendInterviewResponse(true);
        }
        function closeInterview() { document.getElementById('screen-interview').classList.remove('visible'); }
        async function sendInterviewResponse(isStart = false) {
            const input = document.getElementById('interview-input');
            const log = document.getElementById('interview-log');
            const msg = isStart ? "Start Interview" : input.value;
            if(!msg) return;
            if(!isStart) {
                log.innerHTML += `<div class="bg-gray-700 text-white p-2 rounded text-xs self-end w-3/4 border-l-4 border-yellow-400 mb-2">${msg}</div>`;
                input.value = "";
            }
            const loadId = 'load-' + Date.now();
            log.innerHTML += `<div id="${loadId}" class="text-gray-500 text-xs italic">Evaluating...</div>`;
            log.scrollTop = log.scrollHeight;
            try {
                const role = document.getElementById('job-title').innerText;
                const res = await fetch(`${API_BASE}/interview_chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: msg, history: interviewHistory, role: role })
                });
                const data = await res.json();
                document.getElementById(loadId).remove();
                log.innerHTML += `<div class="bg-red-900 text-red-100 p-3 rounded text-xs w-3/4 border-r-4 border-red-500 font-mono mb-4 shadow-lg"><strong>[INTERVIEWER]</strong><br>${data.reply}</div>`;
                interviewHistory.push(`User: ${msg}`);
                interviewHistory.push(`Interviewer: ${data.reply}`);
                log.scrollTop = log.scrollHeight;
            } catch (e) { document.getElementById(loadId).innerText = "Connection Failed."; }
        }

        // --- GHOST CHART ---
        let chartInstance = null;
        function initGhostChart() {
            const ctx = document.getElementById('roadmapChart');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: statLabels,
                    datasets: [
                        { label: 'You', data: currentStats, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: '#2563eb' },
                        { label: 'Goal', data: targetStats, borderColor: '#9ca3af', borderDash: [5, 5], fill: false }
                    ]
                },
                options: { scales: { r: { ticks: { display: false, maxTicksLimit: 6 }, pointLabels: { font: { size: 9, family: "'Press Start 2P'" } } } }, plugins: { legend: { display: false } } }
            });
        }
        function updateChart() { if (chartInstance) { chartInstance.data.datasets[0].data = currentStats; chartInstance.update(); } }

        // --- INITIALIZE ---
        resizeCat('big');
    </script>
</body>
</html> 